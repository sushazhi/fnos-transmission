name: Build Transmission for fnOS

on:
  push:
    branches: [main, develop]
    tags: [v*]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      version:
        description: "Specific version to build (e.g., 4.1.0)"
        required: false
        default: ""
      webui_version:
        description: "WebUI version (e.g., 0.0.7)"
        required: false
        default: "0.0.7"

permissions:
  contents: write

env:
  APP_VERSION: 4.1.0
  TRANSMISSION_VERSION: 4.1.0
  WEBUI_VERSION: latest
  ARCH: arm64

jobs:
  build:
    name: Build Transmission
    runs-on: ubuntu-22.04-arm

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq --no-install-recommends \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            libssl-dev \
            libcurl4-openssl-dev \
            zlib1g-dev \
            libminiupnpc-dev \
            libappindicator3-dev \
            git \
            wget \
            unzip

      - name: Get versions
        id: versions
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ env.TRANSMISSION_VERSION }}"
          fi

          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.webui_version }}" ]; then
            WEBUI_VERSION="${{ github.event.inputs.webui_version }}"
          elif [ "${{ env.WEBUI_VERSION }}" = "latest" ]; then
            WEBUI_VERSION=$(curl -s https://api.github.com/repos/jianxcao/transmission-web/releases/latest | sed -n 's/.*"tag_name":"v\([^"]*\)".*/\1/p')
          else
            WEBUI_VERSION="${{ env.WEBUI_VERSION }}"
          fi
          
          echo "TRANSMISSION_VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "WEBUI_VERSION=${WEBUI_VERSION}" >> $GITHUB_OUTPUT
          echo "Building Transmission ${VERSION} with WebUI ${WEBUI_VERSION}"

      - name: Check for cached binaries
        id: check_cache
        run: |
          echo "Checking for cached binaries..."

          # Check if VERSION file exists in builds/
          if [ -f "builds/VERSION" ]; then
            echo "Found cached VERSION file"

            # Read cached versions
            source builds/VERSION

            echo "Cached Transmission version: ${TRANSMISSION_VERSION}"
            echo "Cached WebUI version: ${WEBUI_VERSION}"
            echo "Cached build date: ${BUILT_AT}"

            # Compare with requested versions
            if [ "${TRANSMISSION_VERSION}" = "${{ steps.versions.outputs.TRANSMISSION_VERSION }}" ] && \
               [ "${WEBUI_VERSION}" = "${{ steps.versions.outputs.WEBUI_VERSION }}" ]; then
              echo "âœ… Cached binaries match requested versions!"
              echo "USE_CACHE=true" >> $GITHUB_OUTPUT
              echo "CACHED_AT=${BUILT_AT}" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ Cached versions don't match, will rebuild"
              echo "USE_CACHE=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "No cached binaries found, will build from source"
            echo "USE_CACHE=false" >> $GITHUB_OUTPUT
          fi

      - name: Use cached binaries (if available)
        if: steps.check_cache.outputs.USE_CACHE == 'true'
        run: |
          echo "âœ… Using cached binaries from ${{ steps.check_cache.outputs.CACHED_AT }}"
          echo ""
          echo "Cached binary info:"
          ls -lh builds/

          # Verify binaries exist
          if [ ! -f "builds/transmission-daemon" ]; then
            echo "âŒ Cached binary missing, falling back to build"
            echo "USE_CACHE=false" >> $GITHUB_ENV
            exit 1
          fi

          # Copy cached binaries to app/bin
          mkdir -p app/bin
          cp builds/transmission-daemon app/bin/

          if [ -f "builds/transmission-cli" ]; then
            cp builds/transmission-cli app/bin/
          fi

          if [ -f "builds/transmission-remote" ]; then
            cp builds/transmission-remote app/bin/
          fi

          chmod +x app/bin/*

          echo ""
          echo "âœ… Cached binaries copied to app/bin:"
          ls -lh app/bin/

      - name: Download source and WebUI (parallel)
        if: steps.check_cache.outputs.USE_CACHE != 'true'
        run: |
          echo "Downloading Transmission source and WebUI in parallel..."
          echo ""

          # Download in parallel
          wget -q "https://github.com/transmission/transmission/releases/download/${{ steps.versions.outputs.TRANSMISSION_VERSION }}/transmission-${{ steps.versions.outputs.TRANSMISSION_VERSION }}.tar.xz" -O /tmp/transmission.tar.xz &
          wget -q "https://github.com/jianxcao/transmission-web/releases/download/v${{ steps.versions.outputs.WEBUI_VERSION }}/transmission-web-v${{ steps.versions.outputs.WEBUI_VERSION }}.zip" -O /tmp/webui.zip &
          wait

          if [ ! -s /tmp/transmission.tar.xz ]; then
            echo "ERROR: Failed to download Transmission source"
            exit 1
          fi

          if [ ! -s /tmp/webui.zip ]; then
            echo "ERROR: Failed to download transmission-web UI"
            exit 1
          fi

          echo "Downloaded Transmission: $(ls -lh /tmp/transmission.tar.xz | awk '{print $5}')"
          echo "Downloaded WebUI: $(ls -lh /tmp/webui.zip | awk '{print $5}')"

      - name: Extract source and WebUI
        if: steps.check_cache.outputs.USE_CACHE != 'true'
        run: |
          mkdir -p /tmp/transmission-build
          cd /tmp/transmission-build
          tar -xf /tmp/transmission.tar.xz --strip-components=1

          mkdir -p /tmp/webui
          cd /tmp/webui
          unzip -q /tmp/webui.zip

          echo "Source structure:"
          ls -la /tmp/transmission-build | head -10
          echo "WebUI structure:"
          ls -la /tmp/webui | head -10

      - name: Build Transmission for ARM64
        if: steps.check_cache.outputs.USE_CACHE != 'true'
        run: |
          cd /tmp/transmission-build
          rm -rf build
          mkdir -p build
          cd build

          # Configure for native ARM64 build - use GCC to avoid clang-tidy crash
          export CC=gcc CXX=g++
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER=gcc \
            -DCMAKE_CXX_COMPILER=g++ \
            -DRUN_CLANG_TIDY=OFF \
            -DBUILD_SHARED_LIBS=ON \
            -DENABLE_CLI=ON \
            -DENABLE_DAEMON=ON \
            -DENABLE_WEB=OFF \
            -DENABLE_GTK=OFF \
            -DENABLE_QT=OFF \
            -DENABLE_MAC=OFF \
            -DENABLE_WIN=OFF \
            -DENABLE_TESTS=OFF \
            -DUSE_SYSTEMD=OFF \
            -DENABLE_LIBUPNP=ON

          echo ""
          echo "CMake configured successfully"
          ls -la

      - name: Compile binaries
        if: steps.check_cache.outputs.USE_CACHE != 'true'
        run: |
          cd /tmp/transmission-build/build

          # Check available targets first
          echo "Available targets:"
          make help | grep -E "^  transmission" || true

          # Build all transmission targets
          make -j$(nproc) transmission-daemon transmission-cli transmission-remote || \
          make -j$(nproc) all

          echo ""
          echo "Build completed:"
          ls -la daemon/ cli/ utils/ 2>/dev/null || find . -name "transmission-*" -type f -executable

      - name: Prepare app structure
        run: |
          mkdir -p app/src/build app/bin

          if [ "${{ steps.check_cache.outputs.USE_CACHE }}" = "true" ]; then
            echo "Using cached binaries..."
          else
            echo "Using newly built binaries..."

            # Copy built binaries
            if [ -f "/tmp/transmission-build/build/daemon/transmission-daemon" ]; then
              cp /tmp/transmission-build/build/daemon/transmission-daemon app/bin/
            elif [ -f "/tmp/transmission-build/build/transmission-daemon" ]; then
              cp /tmp/transmission-build/build/transmission-daemon app/bin/
            else
              echo "ERROR: transmission-daemon not found"
              find /tmp/transmission-build -name "transmission-daemon" -type f
              exit 1
            fi

            # Copy other utilities if available
            find /tmp/transmission-build/build -name "transmission-cli" -type f -exec cp {} app/bin/ \; 2>/dev/null || true
            find /tmp/transmission-build/build -name "transmission-remote" -type f -exec cp {} app/bin/ \; 2>/dev/null || true

            chmod +x app/bin/*
          fi

          # Always copy WebUI to app/ui/ (not app/ui/transmission/)
          if [ -d "/tmp/webui" ]; then
            cp -r /tmp/webui/* app/ui/
          else
            echo "WebUI not found, checking cache..."
          fi

          # Remove transmission subfolder if it exists
          rm -rf app/ui/transmission 2>/dev/null || true

          # Copy libminiupnpc shared library for self-contained deployment
          mkdir -p app/lib
          libminiupnpc=$(find /usr/lib -name "libminiupnpc.so.*" -type f 2>/dev/null | head -1)
          if [ -n "$libminiupnpc" ] && [ -f "$libminiupnpc" ]; then
            cp "$libminiupnpc" app/lib/
            echo "Copied libminiupnpc: $(ls app/lib/)"
          else
            echo "WARNING: libminiupnpc not found, binary may not run"
          fi

          echo "App structure prepared:"
          echo "Binaries:"
          ls -lh app/bin/
          echo "Libraries:"
          ls -la app/lib/ 2>/dev/null || echo "(no libs)"

      - name: Verify binary
        run: |
          BINARY="app/bin/transmission-daemon"
          if [ ! -f "$BINARY" ]; then
            echo "ERROR: transmission-daemon not found"
            exit 1
          fi
          
          echo "Binary verification:"
          file "$BINARY"
          ls -lh "$BINARY"
          
          # Verify WebUI
          if [ ! -f "app/ui/index.html" ]; then
            echo "ERROR: WebUI index.html not found at app/ui/index.html"
            exit 1
          fi

          echo "WebUI verification:"
          ls -la app/ui/ | head -5

      - name: Download fnpack
        run: |
          wget -q https://static2.fnnas.com/fnpack/fnpack-1.2.1-linux-arm64 -O fnpack
          chmod +x fnpack

      - name: Build .fpk package
        run: |
          ./fnpack build .
          PACKAGE_NAME="transmission-${APP_VERSION}-arm64.fpk"
          mv transmission.fpk "${PACKAGE_NAME}"
          echo "PACKAGE_NAME=${PACKAGE_NAME}" >> $GITHUB_ENV

      - name: Create SHA256 checksums
        run: |
          sha256sum "${PACKAGE_NAME}" > "${PACKAGE_NAME}.sha256sum"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: transmission-arm64-fpk
          path: |
            ${{ env.PACKAGE_NAME }}
            ${{ env.PACKAGE_NAME }}.sha256sum
          retention-days: 30

      - name: Build summary
        run: |
          # Determine cache status
          if [ "${{ steps.check_cache.outputs.USE_CACHE }}" = "true" ]; then
            BUILD_METHOD="ðŸš€ Cached binaries (instant)"
            CACHE_INFO="**Source:** ${{ steps.check_cache.outputs.CACHED_AT }}"
          else
            BUILD_METHOD="ðŸ”¨ Native compilation from source"
            CACHE_INFO="**Build Time:** $(date)"
          fi

          cat << EOF >> $GITHUB_STEP_SUMMARY
          ## Build Summary - Transmission for fnOS

          **Version:** ${{ env.APP_VERSION }}
          **Transmission Version:** ${{ steps.versions.outputs.TRANSMISSION_VERSION }}
          **WebUI Version:** ${{ steps.versions.outputs.WEBUI_VERSION }}
          **Architecture:** arm64

          **Build Method:** ${BUILD_METHOD}
          ${CACHE_INFO}

          **Git Info:**
          - Commit: \`${{ github.sha }}\`
          - Branch: \`${{ github.ref_name }}\`
          - Triggered by: ${{ github.event_name }}

          **Components:**
          - Transmission daemon: ARM64 binary
          - WebUI: transmission-web v${{ steps.versions.outputs.WEBUI_VERSION }}
          - CLI utilities: Included

          **Build Artifacts:**
          - Package: \`${PACKAGE_NAME}\`
          - Checksum: \`${PACKAGE_NAME}.sha256sum\`

          **WebUI Features:**
          - Modern responsive interface
          - Chinese language support
          - Auto theme detection
          - Enhanced user experience
          EOF

      - name: Commit binaries and fpk to repository
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Get target branch
          TARGET_BRANCH="main"
          echo "Target branch: ${TARGET_BRANCH}"

          # Fetch latest changes
          git fetch origin ${TARGET_BRANCH}

          # Create builds and artifacts directories
          mkdir -p builds artifacts

          # ===== Copy binaries to builds/ =====
          if [ -f "app/bin/transmission-daemon" ]; then
            cp app/bin/transmission-daemon builds/
            echo "Copied transmission-daemon to builds/"
          fi

          # Copy CLI tools if available
          for tool in transmission-cli transmission-remote; do
            if [ -f "app/bin/$tool" ]; then
              cp app/bin/$tool builds/
              echo "Copied $tool to builds/"
            fi
          done

          # Create VERSION file
          cat > builds/VERSION << EOF
          TRANSMISSION_VERSION=${{ steps.versions.outputs.TRANSMISSION_VERSION }}
          WEBUI_VERSION=${{ steps.versions.outputs.WEBUI_VERSION }}
          APP_VERSION=${{ env.APP_VERSION }}
          ARCH=arm64
          BUILT_AT=$(date -u +%Y-%m-%d-%H:%M:%S)
          COMMIT=${{ github.sha }}
          EOF

          echo "Created VERSION file"
          cat builds/VERSION

          # ===== Copy fpk to artifacts/ =====
          FPK_NAME="transmission-${{ env.APP_VERSION }}-arm64.fpk"
          FPK_CHECKSUM="${FPK_NAME}.sha256sum"

          if [ -f "$FPK_NAME" ]; then
            cp "$FPK_NAME" artifacts/
            echo "Copied $FPK_NAME to artifacts/"
          else
            echo "Warning: $FPK_NAME not found"
          fi

          if [ -f "$FPK_CHECKSUM" ]; then
            cp "$FPK_CHECKSUM" artifacts/
            echo "Copied $FPK_CHECKSUM to artifacts/"
          fi

          # List files to be committed
          echo ""
          echo "Files in builds/:"
          ls -lh builds/
          echo ""
          echo "Files in artifacts/:"
          ls -lh artifacts/

          # Add and commit
          git add -f builds/ artifacts/
          git merge --no-edit origin/${TARGET_BRANCH} || true

          echo "ci: add build artifacts $(date -u +%Y-%m-%d)" > /tmp/commit_msg.txt
          git commit -F /tmp/commit_msg.txt

          # Push to main branch
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git HEAD:${TARGET_BRANCH}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

