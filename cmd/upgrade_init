#!/bin/bash
# cmd/upgrade_init - Transmission升级初始化脚本
# 功能：升级前停止服务并备份数据

set -e

# 错误日志文件
ERROR_LOG="${TRIM_TEMP_LOGFILE:-/tmp/transmission-daemon_error.log}"

# 写入错误日志并退出
error_exit() {
    local message="$1"
    local exit_code="${2:-1}"
    echo "$message" > "$ERROR_LOG"
    exit $exit_code
}

APP_NAME="transmission-daemon"
BIN_DIR="${TRIM_APPDEST}/bin"
DATA_DIR="${TRIM_PKGVAR}"
CONFIG_DIR="${DATA_DIR}/settings.json"
PID_FILE="${TRIM_PKGTMP}/${APP_NAME}.pid"

# 备份到shares目录（fnOS卸载/升级时保留）
SHARE_DIR="/vol1/@appshare/transmission"
BACKUP_DIR="${SHARE_DIR}/.data_backup"
BACKUP_INFO_FILE="${SHARE_DIR}/.backup_info"

# 获取用户选择的数据处理方式
DATA_ACTION="${wizard_data_action:-keep}"
echo "用户选择的数据处理方式: $DATA_ACTION"

echo "=================================="
echo "Transmission 升级开始"
echo "=================================="
echo ""

# 停止服务
echo "[1/3] 停止 ${APP_NAME} 服务..."

STOPPED=false
if [ -x "${TRIM_APPDEST}/cmd/main" ]; then
    "${TRIM_APPDEST}/cmd/main" stop && STOPPED=true || echo "停止命令执行失败或服务已停止"
elif [ -f "$PID_FILE" ]; then
    PID=$(cat "$PID_FILE")
    if ps -p "$PID" > /dev/null 2>&1; then
        echo "停止进程 (PID: $PID)..."
        kill "$PID" 2>/dev/null || true

        TIMEOUT=30
        while ps -p "$PID" > /dev/null 2>&1 && [ $TIMEOUT -gt 0 ]; do
            sleep 1
            TIMEOUT=$((TIMEOUT - 1))
        done

        if ps -p "$PID" > /dev/null 2>&1; then
            echo "强制终止进程..."
            kill -9 "$PID" 2>/dev/null || true
        fi
        STOPPED=true
    fi
fi

rm -f "$PID_FILE"

if [ "$STOPPED" = true ]; then
    echo "服务已停止"
else
    echo "服务已停止或停止失败，继续升级"
fi

# 处理数据
echo ""
echo "[2/3] 根据用户选择处理数据..."

if [ "$DATA_ACTION" = "delete" ]; then
    echo "用户选择删除所有数据"
    if [ -d "$DATA_DIR" ]; then
        rm -rf "$DATA_DIR"
        echo "数据目录已删除: $DATA_DIR"
    fi
    rm -rf "${SHARE_DIR}/.data_backup"* 2>/dev/null || true
else
    echo "用户选择保留数据，主动备份..."
    
    if [ -d "$DATA_DIR" ] && [ -n "$(ls -A "$DATA_DIR" 2>/dev/null)" ]; then
        # 创建备份目录
        if ! mkdir -p "$BACKUP_DIR" 2>/dev/null; then
            error_exit "错误：无法创建备份目录，升级失败"
        fi

        # 复制所有数据
        if ! cp -a "$DATA_DIR"/* "$BACKUP_DIR/" 2>/dev/null; then
            error_exit "错误：备份数据失败，升级终止"
        fi

        # 验证备份
        if [ -f "${BACKUP_DIR}/settings.json" ] || [ -n "$(ls -A "$BACKUP_DIR" 2>/dev/null)" ]; then
            echo "数据已成功备份到: $BACKUP_DIR"
            echo "BACKUP_DIR=$BACKUP_DIR" > "$BACKUP_INFO_FILE"
        else
            error_exit "错误：备份验证失败，升级终止"
        fi
    else
        echo "无现有数据需要备份或数据目录为空"
    fi
fi

echo ""
echo "=================================="
echo "Transmission 升级初始化完成"
echo "=================================="
exit 0
