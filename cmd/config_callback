#!/bin/bash
# cmd/config_callback - Transmission配置回调脚本
# 功能：应用或更新用户配置的用户名密码

set -e

APP_NAME="transmission-daemon"
DATA_DIR="${TRIM_PKGVAR}"
CONFIG_DIR="${DATA_DIR}/settings.json"
ERROR_LOG="${TRIM_TEMP_LOGFILE:-/tmp/${APP_NAME}_error.log}"

echo "正在应用 Transmission 配置..."

# 检查配置目录
if [ -z "$DATA_DIR" ]; then
    echo "错误：TRIM_PKGVAR 环境变量未设置" > "$ERROR_LOG"
    exit 1
fi

# 创建配置目录
mkdir -p "$DATA_DIR"

# 获取用户配置（从向导或环境变量）
RPC_USERNAME="${wizard_rpc_username:-${RPC_USERNAME:-admin}}"
RPC_PASSWORD="${wizard_rpc_password:-${RPC_PASSWORD:-password}}"

# 获取端口配置
if [ -n "$TRIM_SERVICE_PORT" ]; then
    WEBUI_PORT="$TRIM_SERVICE_PORT"
else
    WEBUI_PORT=9090
fi

# 读取现有配置或创建新配置
if [ -f "$CONFIG_DIR" ]; then
    echo "更新现有配置..."
else
    echo "创建新配置..."
    mkdir -p "$(dirname "$CONFIG_DIR")"
fi

cat > "$CONFIG_DIR" << EOF
{
    "download-dir": "/vol1/1000/downloads",
    "incomplete-dir": "/vol1/1000/temp",
    "incomplete-dir-enabled": true,
    "dht-enabled": true,
    "pex-enabled": true,
    "lpd-enabled": true,
    "encryption": 1,
    "peer-limit-global": 200,
    "peer-port": 51413,
    "peer-port-random-on-start": true,
    "rpc-enabled": true,
    "rpc-authentication-required": true,
    "rpc-port": ${WEBUI_PORT},
    "rpc-url": "/transmission/",
    "rpc-username": "${RPC_USERNAME}",
    "rpc-password": "${RPC_PASSWORD}",
    "start-added-torrents": true,
    "utp-enabled": true
}
EOF

echo ""
echo "==================================="
echo "Transmission 配置已应用"
echo "==================================="
echo ""
echo "用户名: ${RPC_USERNAME}"
echo "⚠️  重要：请在首次登录后立即修改默认密码！"
echo ""
echo "WebUI: http://<NAS_IP>:9090/transmission/"
echo ""

echo "Transmission 配置应用完成"
exit 0
