#!/bin/bash
# cmd/install_callback - Transmission安装后置脚本

set -e

APP_NAME="transmission-daemon"
BIN_DIR="${TRIM_APPDEST}/bin"
DATA_DIR="${TRIM_PKGVAR}"
CONFIG_DIR="${DATA_DIR}/settings.json"
ERROR_LOG="${TRIM_TEMP_LOGFILE:-/tmp/${APP_NAME}_error.log}"

echo "Running ${APP_NAME} install_callback..."

# 设置可执行权限
if ! chmod +x "$BIN_DIR/transmission-daemon" 2>/dev/null; then
    echo "Error: Failed to set executable permission" > "$ERROR_LOG"
    exit 1
fi

# 获取用户配置（从向导或环境变量）
# 向导变量名: wizard_rpc_username, wizard_rpc_password
RPC_USERNAME="${wizard_rpc_username:-${RPC_USERNAME:-admin}}"
RPC_PASSWORD="${wizard_rpc_password:-${RPC_PASSWORD:-password}}"

echo "Applying configuration..."
echo "Username: ${RPC_USERNAME}"

# 获取端口配置
if [ -n "$TRIM_SERVICE_PORT" ]; then
    WEBUI_PORT="$TRIM_SERVICE_PORT"
else
    WEBUI_PORT=9090
fi

# 创建配置目录
mkdir -p "$DATA_DIR"

# 生成配置文件（使用 cat 配合 EOF 注入变量值）
cat > "$CONFIG_DIR" << EOF
{
    "download-dir": "/vol1/1000/downloads",
    "incomplete-dir": "/vol1/1000/temp",
    "incomplete-dir-enabled": true,
    "dht-enabled": true,
    "pex-enabled": true,
    "lpd-enabled": true,
    "encryption": 1,
    "peer-limit-global": 200,
    "peer-port": 51413,
    "peer-port-random-on-start": true,
    "rpc-enabled": true,
    "rpc-authentication-required": true,
    "rpc-port": ${WEBUI_PORT},
    "rpc-url": "/transmission/",
    "rpc-username": "${RPC_USERNAME}",
    "rpc-password": "${RPC_PASSWORD}",
    "start-added-torrents": true,
    "utp-enabled": true
}
EOF

echo ""
echo "=================================="
echo "Transmission installation complete"
echo "=================================="
echo ""
echo "WebUI: http://<NAS_IP>:9090/transmission/"
echo ""
echo "Username: ${RPC_USERNAME}"
echo "Password: ${RPC_PASSWORD}"
echo ""
echo "⚠️  Important: Change the default password after first login!"
echo ""
echo "Data location: $DATA_DIR"
echo "Config location: $CONFIG_DIR"
echo ""

echo "Transmission installed successfully"
exit 0
